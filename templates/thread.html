<!DOCTYPE html>
<html lang="ja">
<head>
<link rel="icon" href="favicon.ico">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ thread[1] }}</title>
  <style>
    /* CSSスタイル */
  </style>
</head>
<style>
a {
        text-decoration: none;
color: #000000;        
} 


button {
  background: transparent;
}
</style>
<body class="theme-{{theme}}">
<a href="/">← スレッド一覧に戻る</a>
<h1>{{ thread[1] }}</h1>
<p>現在の接続人数: <span id="onlineCount">0</span> 人</p>
<ul id="posts">
  {% for post in posts %}
    <li>{{ post.num }} <b>{{ post.name | safe }}</b><br> {{ post.message | safe }} <span>({{ post.created_at }})</span></li>
  {% endfor %}
</ul>

<p>※自動更新システムを使用していますが、稀に更新されない場合がございます。その際は再読み込みをお願いします</p>

<form id="postForm" action="/post-message" method="POST"> <!-- actionとmethodを追加 -->
  名前: <input type="text" name="name"><br>
  本文: <textarea name="message" id="messageArea"></textarea><br>
  <!-- 通常の書き込みボタン -->
  <button type="submit">
    <img src="https://icooon-mono.com/i/icon_11449/icon_114490_256.jpg" height ="20" width="20" alt="投稿" />
  </button>
</form>

<!-- 画像アップロードは別のフォームとして完全に分離 -->
<form id="uploadForm" enctype="multipart/form-data">
    <input type="file" id="fileInput" name="imageFile" accept="image/*" required>
    <!-- アップロード実行ボタン -->
    <button type="submit">
        <img src="https://sozai.cman.jp/img-icon/scene_mountain1.png" height ="20" width="20" alt="画像をアップロード" />
    </button>
</form>


<script>
document.getElementById('uploadForm').addEventListener('submit', function(event) {
    event.preventDefault(); // デフォルトのフォーム送信を停止

    const fileInput = document.getElementById('fileInput');
    const messageArea = document.getElementById('messageArea');
    const file = fileInput.files[0];

    if (file) {
        const formData = new FormData();
        formData.append('imageFile', file);

        const uploadUrl = 'hei-bu-jing.onrender.com';
 

        fetch(uploadUrl, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                // HTTPエラーが発生した場合にエラーを投げる
                throw new Error('ネットワーク応答が不正です: ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            if (data.url) {
                // 画像をMarkdown形式で本文エリアに挿入
                messageArea.value += `\n![画像](${data.url})\n`; 
                console.log('アップロード成功:', data.url);
                alert('画像のアップロードが完了しました。本文にURLが追加されました。');
                fileInput.value = ''; // 選択したファイルをクリアする
            } else {
                console.error('URLがレスポンスに含まれていません。サーバーのレスポンス:', data);
                alert('アップロード失敗: サーバーからのURLが不正です。');
            }
        })
        .catch(error => {
            console.error('アップロード中にエラーが発生しました:', error);
            alert('ファイルのアップロード中にエラーが発生しました。CORS設定やエンドポイントURLを確認してください。');
        });
    } else {
        alert('ファイルを選択してください。');
    }
});
</script>



<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
// --- ユーティリティ ---
// HTML を安全にエスケープする（XSS対策）
function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

// >>n と &gt;&gt;n の両方に対応してアンカーに変換
function convertAnchorsHtml(escapedHtml) {
    // escapedHtml はすでにエスケープ済み (& -> &amp; など)
    // なので &gt;&gt;123 と >>123 の両方を扱う
    return escapedHtml
      .replace(/&gt;&gt;(\d+)/g, (m, n) => `<span class="anchor" data-target="${n}">&gt;&gt;${n}</span>`)
      .replace(/>>(\d+)/g, (m, n) => `<span class="anchor" data-target="${n}">&gt;&gt;${n}</span>`);
}

// 画像URL を <img> に置換（既にエスケープされた中身に対して使う）
function convertImageUrlsHtml(html) {
    // URL 正規表現（簡易）
    const re = /(https?:\/\/[^\s"']+\.(?:jpg|jpeg|png|gif|bmp|webp))/gi;
    return html.replace(re, (url) => `<img src="${url}" alt="image" style="max-height:120px;">`);
}

// メッセージを表示用 HTML に変換：エスケープ→改行→アンカー→画像
function messageToHtml(rawMessage) {
    if (!rawMessage) return "";
    // 1) エスケープ
    let h = escapeHtml(rawMessage);
    // 2) 改行を <br>
    h = h.replace(/\r?\n/g, '<br>');
    // 3) アンカー変換
    h = convertAnchorsHtml(h);
    // 4) 画像URL変換（最後に）
    h = convertImageUrlsHtml(h);
    return h;
}

// --- DOM に投稿を追加する ---
const postsList = document.getElementById("posts");
function addPostToDOM(post) {
    const li = document.createElement('li');
    li.className = 'color-box';
    // idを post.num として付ける（アンカーポップアップで参照）
    li.id = String(post.num);

    // post のフィールドはサーバーから来る raw text（安全のため messageToHtml を使う）
    const nameHtml = escapeHtml(post.name || "名無しさん");
    const msgHtml = messageToHtml(post.message || "");

    li.innerHTML = `#${post.num} <b>${nameHtml}</b><br><div class="htn">${msgHtml}</div><br><span>(${escapeHtml(post.created_at || "")})</span>`;
    postsList.appendChild(li);

    // 着色（任意）
    const color = generatePastelColor();
    li.style.backgroundColor = color;
    li.style.setProperty('--after-color', color);
}

// --- 初期ロード: JSON を取って描画する ---
// 既にテンプレートでレンダリングしているなら、その要素は空にするか無視すること
async function fetchAndRenderPosts() {
    try {
        const res = await fetch(`/thread/${threadId}/posts_json`);
        if (!res.ok) {
            console.error('posts_json error', res.status);
            return;
        }
        const posts = await res.json();
        postsList.innerHTML = '';
        posts.forEach(p => addPostToDOM(p));
    } catch (err) {
        console.error('fetch posts error', err);
    }
}

// --- Socket.IO の新着を受け取った時の処理 ---
// 既にある addPostToDOM を利用する（post は JSON）
socket.on('new_post', post => {
    // 新着は num 等を持っているはず
    addPostToDOM(post);
});

// --- イベント委譲: アンカークリックでポップアップ表示 ---
document.addEventListener('click', function(e) {
    const anchor = e.target.closest('.anchor');
    if (!anchor) return;
    const targetNum = anchor.dataset.target;
    if (!targetNum) return;

    const targetEl = document.getElementById(String(targetNum));
    if (!targetEl) {
        // 該当レスがまだ読み込まれてない、もしくは存在しない
        alert('該当レスは見つかりませんでした: ' + targetNum);
        return;
    }
    // 座標はマウス位置（ページ座標）
    showPopup(targetEl, e.pageX, e.pageY);
});

// ポップアップの表示（渡すのは DOM 要素）
function showPopup(postElement, pageX, pageY) {
    const old = document.getElementById('anchorPopup');
    if (old) old.remove();

    const popup = document.createElement('div');
    popup.id = 'anchorPopup';
    popup.style.position = 'absolute';
    popup.style.left = pageX + 'px';
    popup.style.top = pageY + 'px';
    popup.style.maxWidth = '360px';
    popup.style.padding = '8px';
    popup.style.background = '#ffffe0';
    popup.style.border = '1px solid #aaa';
    popup.style.borderRadius = '6px';
    popup.style.zIndex = 99999;
    popup.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
    popup.style.fontSize = '13px';
    // 中身は target のメッセージ表示部だけにする（余計なボタンなどは含めない）
    const content = postElement.querySelector('.htn')?.innerHTML || postElement.innerHTML;
    popup.innerHTML = content;
    document.body.appendChild(popup);

    // 右端はみ出し防止
    const rect = popup.getBoundingClientRect();
    if (rect.right > window.innerWidth) {
        popup.style.left = (pageX - rect.width - 20) + 'px';
    }
    if (rect.bottom > window.innerHeight) {
        popup.style.top = (pageY - rect.height - 20) + 'px';
    }
}

// ポップアップ外をクリックしたら消す
document.addEventListener('click', function(e) {
    const popup = document.getElementById('anchorPopup');
    if (!popup) return;
    if (!e.target.closest('#anchorPopup') && !e.target.closest('.anchor')) {
        popup.remove();
    }
});

// --- 初回レンダリングを実行 ---
fetchAndRenderPosts();

// （必要なら）一定間隔で再フェッチする場合はここで setInterval(fetchAndRenderPosts, 5000);
</script>




</body>
</html>
