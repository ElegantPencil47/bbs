<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>{{ thread[1] }}</title>
    <style>
        /* LINE風のレイアウト用CSS */
        #posts { list-style: none; padding: 0; }
        .post-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        .color-box {
            padding: 10px;
            border-radius: 15px;
            position: relative;
            max-width: 80%;
            word-wrap: break-word;
        }
        .user-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            margin-top: -10px;
            margin-left: 10px;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #fixed { position: fixed; bottom: 20px; right: 20px; }
    </style>
</head>
<body>

<h1>{{ thread[1] }}</h1>
<p>現在の接続人数: <span id="onlineCount">0</span> 人</p>

<ul id="posts">
  {% for post in posts %}
  <li class="post-container">
    <div class="color-box" id="{{ post.num }}">
      {{ post.num }} <b>{{ post.name | safe }}</b>
      <div class="htn">{{ post.message | imgify }}</div>
      <span>({{ post.created_at }})</span>
    </div>
    <img src="{{ post.icon_url if post.icon_url else 'https://encrypted-tbn0.gstatic.com' }}" class="user-icon">
  </li>
  {% endfor %}
</ul>

<div class="kakiko">
  <form id="postForm" enctype="multipart/form-data">
    名前: <input type="text" name="name"><br>
    
    <!-- アイコン設定 -->
    アイコン設定: <input type="file" id="iconInput" accept="image/*">
    <input type="hidden" name="icon_url" id="uploadedIconUrl" value="">
    <br>

    本文: <textarea name="message" id="messageArea"></textarea><br>

    画像の投稿: <input type="file" id="fileInput" accept="image/*">
    <div id="result"></div>

    AAの投稿
    <div>
        <select id="mySelect">
            <option value="">AAを選択</option>
            <option value="option1">画像も貼らずにスレ立てとな？</option>
            <option value="option2">不快なスレを立てるなですぅ</option>
            <option value="option3">変態だ！</option>
        </select>
    </div>
    <button type="submit">投稿する</button>
  </form>
</div>

<a href="#top"><img src="/static/pagetop.png" height="80" id="fixed"></a>

<script src="https://cdn.socket.io"></script>
<script>
const threadId = {{ thread_id }};
const postsList = document.getElementById("posts");
const socket = io({ transports: ["websocket"] });

function generatePastelColor() {
  const hue = Math.floor(Math.random() * 360);
  return `hsl(${hue}, 80%, 85%)`;
}

function safeNl2br(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML.replace(/\n/g, '<br>');
}

function convertImageUrls(text) {
    const urlRegex = /(https?:\/\/[^\s]+)/gi;
    return text.replace(urlRegex, (url) => {
        if (url.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
            return `<br><a href="${url}" target="_blank"><img src="${url}" style="max-height:120px; display:block;"></a>`;
        }
        return `<a href="${url}" target="_blank">${url}</a>`;
    });
}

function convertAnchors(text) {
    return text.replace(/&gt;&gt;(\d+)/g, '<span class="anchor" data-target="$1">&gt;&gt;$1</span>');
}

// 新しい投稿を画面に追加する関数
function addPostToDOM(post) {
    const li = document.createElement("li");
    li.className = "post-container";

    const iconSrc = post.icon_url || "https://encrypted-tbn0.gstatic.com";
    let msg = safeNl2br(post.message);
    msg = convertImageUrls(msg);
    msg = convertAnchors(msg);

    li.innerHTML = `
      <div class="color-box" id="${post.num}">
        ${post.num} <b>${post.name}</b>
        <div class="htn">${msg}</div>
        <span>(${post.created_at})</span>
      </div>
      <img src="${iconSrc}" class="user-icon">
    `;

    postsList.appendChild(li);
    const color = generatePastelColor();
    const box = li.querySelector('.color-box');
    box.style.backgroundColor = color;
}

// アイコンアップロード
document.getElementById("iconInput").addEventListener("change", async function() {
    const file = this.files[0];
    if (!file) return;
    const formData = new FormData();
    formData.append("imageFile", file);
    const res = await fetch("/upload", { method: "POST", body: formData });
    const data = await res.json();
    if (data.url) {
        document.getElementById("uploadedIconUrl").value = data.url;
        alert("アイコンをセットしました");
    }
});

// 本文用画像アップロード
document.getElementById("fileInput").addEventListener("change", async function() {
    const file = this.files[0];
    if (!file) return;
    const formData = new FormData();
    formData.append("imageFile", file);
    const res = await fetch("/upload", { method: "POST", body: formData });
    const data = await res.json();
    if (data.url) {
        document.getElementById("messageArea").value += "\n" + data.url;
    }
});

// 投稿フォーム送信
document.getElementById("postForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const res = await fetch(`/thread/${threadId}/add_post`, { method: "POST", body: formData });
    if (res.ok) { e.target.reset(); document.getElementById("uploadedIconUrl").value = ""; }
});

socket.on("connect", () => socket.emit("join_thread", { thread_id: threadId }));
socket.on("new_post", (post) => addPostToDOM(post));
socket.on("online_count", (count) => document.getElementById("onlineCount").textContent = count);

// 初期表示の色付け
document.querySelectorAll('.color-box').forEach(box => {
    box.style.backgroundColor = generatePastelColor();
});
</script>
</body>
</html>
