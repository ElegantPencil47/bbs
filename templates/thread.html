<!DOCTYPE html>
<html lang="ja">
<head>
<link rel="icon" href="/static/favicon.ico">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ thread[1] }}</title>

</head>
<style>


a.btn--orange {
  color: black;
padding: 12px;
  background-color: white;
  border-bottom: 5px solid #696969;
}
a.btn--orange:hover {
  margin-top: 3px;
  color: black;
  background: white;
  border-bottom: 2px solid #696969;
}
a.btn--shadow {
  -webkit-box-shadow: 0 3px 5px rgba(0, 0, 0, .3);
  box-shadow: 0 3px 5px rgba(0, 0, 0, .3);
}
a {
        text-decoration: none;
color: #000000;        
} 
button{
  position: relative;
  display: inline-block;
background: white;
  transition: .3s;
}
button: hover{
background: #d3d3d3;
}
button::after {
  position: absolute;
  bottom: 0;
  left: 50%;
  content: '';
  width: 0;
  height: 2px;
  background-color: #31aae2;
  transition: .3s;
  transform: translateX(-50%);
}

button:hover::after{
  width: 100%;
}

nktidksg {
  position: relative;
  background: #ffd98a;
  padding: 2px 5px 2px 25px;
  font-size: 20px;
  color: #474747;
  border-radius: 0 10px 10px 0;
}

.nktidksg:before {
  font-family: "Font Awesome 5 Free";
  content: "\f135";
  display: inline-block;
  line-height: 40px;
  position: absolute;
  padding: 0em;
  color: white;
  background: #ffa337;
  font-weight: 900;
  width: 40px;
  text-align: center;
  height: 40px;
  line-height: 40px;
  left: -1.35em;
  top: 50%;
  -webkit-transform: translateY(-50%);
  transform: translateY(-50%);
  border: solid 3px white; 
  border-radius: 50%;
}


.kakiko{
background-color: #d3d3d3;
display: inline-block;
border: 3px solid #808080;
}
.htn{

    /* 等幅フォントを指定 */
    font-family: 'Monotype', 'MS UI Gothic', monospace;
    /* ホワイトスペースの扱いの設定（preタグなら不要な場合が多いですが、念のため） */
    white-space: pre;
  

}

li {
  position: relative;
  padding: 0.4em;
  border-radius: 0.5em;
 margin: 30px;
display: inline-block;
}

li:after {
  position: absolute;
  content: '';
  top: 100%;
  left: 30px;
  border: 15px solid transparent;
  /* ここをCSSカスタムプロパティに変更 */
  border-top: 15px solid var(--after-color, #e0edff); 
  width: 0;
border-radius: 7px;
  height: 0;
}

body{
background-color: #fffacd;
}
button{
  position: relative;
  display: inline-block;
background: white;
  transition: .3s;
}
button: hover{
background: #d3d3d3;
}
button::after {
  position: absolute;
  bottom: 0;
  left: 50%;
  content: '';
  width: 0;
  height: 2px;
  background-color: #31aae2;
  transition: .3s;
  transform: translateX(-50%);
}

button:hover::after{
  width: 100%;
}

</style>
<body class="theme-{{theme}}">
<a href="/">← スレッド一覧に戻る</a>
<h1>{{ thread[1] }}</h1>
<p>現在の接続人数: <span id="onlineCount">0</span> 人</p>
<ul id="posts">
  {% for post in posts %}
    <li class="color-box" id="{{ post.num }}">
  {{ post.num }} <b>{{ post.name | safe }}</b><div class="htn">{{ post.message | imgify }} </div> <!-- ここを追加 -->
  <span>({{ post.created_at }})</span>
</li>

  {% endfor %}
</ul>

<p>※自動更新システムを使用していますが、稀に更新されない場合がございます。その際は再読み込みをお願いします</p>
<div class="kakiko">
<form id="postForm" enctype="multipart/form-data">
  名前: <input type="text" name="name"><br>

  本文: <textarea name="message" id="messageArea"></textarea><br>

  画像の投稿:<input type="file" id="fileInput" accept="image/*">
<div id="result"></div>

<input type="hidden" name="image_url" id="uploadedImageUrl">  

    
AAの投稿<div>
        <select id="mySelect">
            <option value="">AAを選択</option>
            <option value="option1">画像も貼らずにスレ立てとな？</option>
            <option value="option2">不快なスレを立てるなですぅ</option>
            <option value="option3">変態だ！</option>
            <option value="option4">(怯える)</option>
            <option value="option5">さぁお前の罪を数えろ</option>
        </select>
    </div>
<button type="button" onclick="checkValues()">AAを決定</button>



  <button type="submit">
    <img src="https://icooon-mono.com/i/icon_11449/icon_114490_256.jpg" height ="20" width="20">投稿する
  </button>
</form>


</div>




<script>
// ランダムなHEXカラーコードを生成する関数
function generatePastelColor() {
  // 色相 (Hue): 0から360の間でランダムな値。これにより色の種類（赤、青、緑など）が決まる。
  const hue = Math.floor(Math.random() * 360);

  // 彩度 (Saturation): 60%から100%の間でランダムな値。鮮やかさを指定。
  // 淡い色を生成するためには彩度を完全に低くしすぎないことが重要です。
  const saturation = Math.floor(Math.random() * 40) + 60; // 60% - 100%

  // 明るさ (Lightness): 70%から90%の間でランダムな値。これが「淡さ」の鍵。
  // 100%に近づくほど白に近くなります。
  const lightness = Math.floor(Math.random() * 20) + 70; // 70% - 90%

  // CSSで使用できるhsl形式の文字列を返す
  return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
}




// すべての .color-box 要素を取得する
const colorBoxes = document.querySelectorAll('.color-box');

// 各要素にランダムな色を適用する
colorBoxes.forEach(box => {
    const color = generatePastelColor();
    box.style.backgroundColor = color;
    // ここでCSSカスタムプロパティを設定する
    box.style.setProperty('--after-color', color);
});

</script>


<script>
// 自動アップロード（fileInputを選択した瞬間に走る）
document.getElementById("fileInput").addEventListener("change", async function () {
    const file = this.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append("imageFile", file);  // ← Flask の upload が受け取るキーは imageFile

    try {
        const res = await fetch("/upload", {
            method: "POST",
            body: formData
        });

        const data = await res.json();

        if (!data.url) {
            alert("アップロードに失敗しました");
            return;
        }

        // 自動で textarea に追加
        const textarea = document.getElementById("messageArea");
        textarea.value += "\n" + data.url;

        // 表示
        const fullURL = data.url;
        document.getElementById("result").innerHTML =
            `<p>画像URL:</p>
             <a href="${fullURL}" target="_blank">${fullURL}</a><br>
             <img src="${fullURL}" style="max-width:200px;">`;

        console.log("Uploaded:", fullURL);

    } catch (err) {
        console.error(err);
        alert("通信エラーが発生しました");
    }
});
</script>









<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
// 修正: 必要な変数を定義
const threadId = {{ thread_id }};
const postsList = document.getElementById("posts");
const socket = io({
    transports:["websocket"]
});

// ユーザーが投稿したメッセージを安全にレンダリングする関数
function safeNl2br(text) {
    const escapedText = document.createElement('div');
    escapedText.textContent = text;
    return escapedText.innerHTML.replace(/\r?\n/g, '<br>');
}

// 画像URLを<img>に変換する関数（全サイト対応）
function convertImageUrls(text) {
    const imgRegex = /(https?:\/\/[^\s]+?\.(?:jpg|jpeg|png|gif|bmp|webp))/gi;
    return text.replace(imgRegex, (url) => {
        return `<img src="${url}" alt="Image" height ="120">`;
    });
}

// 投稿をDOMに追加 (色付け機能を追加)
function addPostToDOM(post) {
    const li = document.createElement("li");
    li.classList.add('color-box'); // 新しく追加される投稿にもクラスを追加

    const safeName = safeNl2br(post.name);
    const escapedAndNl2brMessage = safeNl2br(post.message);
let msg = escapedAndNl2brMessage;
msg = convertImageUrls(msg);
msg = convertAnchors(msg);  // ←追加

const finalMessage = msg;


    li.innerHTML = `${post.num} <b>${safeName}</b> <br><div class="htn">${finalMessage}</div><br><span>(${post.created_at})</span>`;
    postsList.appendChild(li);

    // 新しい投稿要素に対して色を適用する
    const color = generatePastelColor();
    li.style.backgroundColor = color;
    li.style.setProperty('--after-color', color);
}

// 初期ロードで投稿一覧を取得
async function fetchPosts() {
    let res = await fetch(`/thread/${threadId}/posts_json`);
    if (res.ok) {
        let posts = await res.json();
        postsList.innerHTML = "";
        // ここではすでにDjangoテンプレートエンジンによってレンダリングされた要素が存在する可能性があるため、
        // 初期ロード時にDOMをクリアしてJSONから再構築するか、既存要素の色を変更する必要があります。
        // 現在のコードは既存の要素は色付けされていますが、fetchPostsで再構築すると色がリセットされます。
        // 初期ロード時のテンプレートレンダリングを削除し、fetchPosts()のみに依存させるのが一番簡単です。
    }
}


// 投稿フォーム送信
document.getElementById("postForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);

    let res = await fetch(`/thread/${threadId}/add_post`, {
        method: "POST",
        body: formData
    });

    if (res.ok) {
        e.target.reset(); // 自分の投稿はSocket.IOで反映
    } else {
        alert("投稿に失敗しました");
    }
});

// Socket.IO
socket.on("connect", () => {
    console.log("connected:", socket.id);
    socket.emit("join_thread",{thread_id:threadId});
});

socket.on("new_post", (post) => addPostToDOM(post));
socket.on("online_count", (count) => {
    document.getElementById("onlineCount").textContent = count;
});

// ページ離脱時
window.addEventListener("beforeunload", () => {
    socket.emit("leave_thread", { thread_id: threadId });
});

// 初期ロード時に、Djangoテンプレートで生成された既存の投稿要素（.color-boxクラスを持つもの）に色を適用する
document.querySelectorAll('.color-box').forEach(box => {
    const color = generatePastelColor();
    box.style.backgroundColor = color;
    box.style.setProperty('--after-color', color);
});


</script>

<script>
// --- ユーティリティ ---
// HTML を安全にエスケープする（XSS対策）
function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

// >>n と &gt;&gt;n の両方に対応してアンカーに変換
function convertAnchorsHtml(escapedHtml) {
    // escapedHtml はすでにエスケープ済み (& -> &amp; など)
    // なので &gt;&gt;123 と >>123 の両方を扱う
    return escapedHtml
      .replace(/&gt;&gt;(\d+)/g, (m, n) => `<span class="anchor" data-target="${n}">&gt;&gt;${n}</span>`)
      .replace(/>>(\d+)/g, (m, n) => `<span class="anchor" data-target="${n}">&gt;&gt;${n}</span>`);
}

// 画像URL を <img> に置換（既にエスケープされた中身に対して使う）
function convertImageUrlsHtml(html) {
    // URL 正規表現（簡易）
    const re = /(https?:\/\/[^\s"']+\.(?:jpg|jpeg|png|gif|bmp|webp))/gi;
    return html.replace(re, (url) => `<img src="${url}" alt="image" style="max-height:120px;">`);
}

// メッセージを表示用 HTML に変換：エスケープ→改行→アンカー→画像
function messageToHtml(rawMessage) {
    if (!rawMessage) return "";
    // 1) エスケープ
    let h = escapeHtml(rawMessage);
    // 2) 改行を <br>
    h = h.replace(/\r?\n/g, '<br>');
    // 3) アンカー変換
    h = convertAnchorsHtml(h);
    // 4) 画像URL変換（最後に）
    h = convertImageUrlsHtml(h);
    return h;
}

// --- DOM に投稿を追加する ---
const postsList = document.getElementById("posts");
function addPostToDOM(post) {
    const li = document.createElement('li');
    li.className = 'color-box';
    // idを post.num として付ける（アンカーポップアップで参照）
    li.id = String(post.num);

    // post のフィールドはサーバーから来る raw text（安全のため messageToHtml を使う）
    const nameHtml = escapeHtml(post.name || "名無しさん");
    const msgHtml = messageToHtml(post.message || "");

    li.innerHTML = `#${post.num} <b>${nameHtml}</b><br><div class="htn">${msgHtml}</div><br><span>(${escapeHtml(post.created_at || "")})</span>`;
    postsList.appendChild(li);

    // 着色（任意）
    const color = generatePastelColor();
    li.style.backgroundColor = color;
    li.style.setProperty('--after-color', color);
}

// --- 初期ロード: JSON を取って描画する ---
// 既にテンプレートでレンダリングしているなら、その要素は空にするか無視すること
async function fetchAndRenderPosts() {
    try {
        const res = await fetch(`/thread/${threadId}/posts_json`);
        if (!res.ok) {
            console.error('posts_json error', res.status);
            return;
        }
        const posts = await res.json();
        postsList.innerHTML = '';
        posts.forEach(p => addPostToDOM(p));
    } catch (err) {
        console.error('fetch posts error', err);
    }
}

// --- Socket.IO の新着を受け取った時の処理 ---
// 既にある addPostToDOM を利用する（post は JSON）
socket.on('new_post', post => {
    // 新着は num 等を持っているはず
    addPostToDOM(post);
});

// --- イベント委譲: アンカークリックでポップアップ表示 ---
document.addEventListener('click', function(e) {
    const anchor = e.target.closest('.anchor');
    if (!anchor) return;
    const targetNum = anchor.dataset.target;
    if (!targetNum) return;

    const targetEl = document.getElementById(String(targetNum));
    if (!targetEl) {
        // 該当レスがまだ読み込まれてない、もしくは存在しない
        alert('該当レスは見つかりませんでした: ' + targetNum);
        return;
    }
    // 座標はマウス位置（ページ座標）
    showPopup(targetEl, e.pageX, e.pageY);
});

// ポップアップの表示（渡すのは DOM 要素）
function showPopup(postElement, pageX, pageY) {
    const old = document.getElementById('anchorPopup');
    if (old) old.remove();

    const popup = document.createElement('div');
    popup.id = 'anchorPopup';
    popup.style.position = 'absolute';
    popup.style.left = pageX + 'px';
    popup.style.top = pageY + 'px';
    popup.style.maxWidth = '360px';
    popup.style.padding = '8px';
    popup.style.background = '#ffffe0';
    popup.style.border = '1px solid #aaa';
    popup.style.borderRadius = '6px';
    popup.style.zIndex = 99999;
    popup.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
    popup.style.fontSize = '13px';
    // 中身は target のメッセージ表示部だけにする（余計なボタンなどは含めない）
    const content = postElement.querySelector('.htn')?.innerHTML || postElement.innerHTML;
    popup.innerHTML = content;
    document.body.appendChild(popup);

    // 右端はみ出し防止
    const rect = popup.getBoundingClientRect();
    if (rect.right > window.innerWidth) {
        popup.style.left = (pageX - rect.width - 20) + 'px';
    }
    if (rect.bottom > window.innerHeight) {
        popup.style.top = (pageY - rect.height - 20) + 'px';
    }
}

// ポップアップ外をクリックしたら消す
document.addEventListener('click', function(e) {
    const popup = document.getElementById('anchorPopup');
    if (!popup) return;
    if (!e.target.closest('#anchorPopup') && !e.target.closest('.anchor')) {
        popup.remove();
    }
});

// --- 初回レンダリングを実行 ---
fetchAndRenderPosts();

// （必要なら）一定間隔で再フェッチする場合はここで setInterval(fetchAndRenderPosts, 5000);
</script>
<br>
<a href="{{ url_for('help') }}" style="font-size:20px;" class="btn btn--orange btn--cubic btn--shadow"><img src="https://www.silhouette-illust.com/wp-content/uploads/2016/05/1327-600x600.jpg" width="40">ヘルプ・ご案内  ></a>
</body>
</html>