<!DOCTYPE html>
<html lang="ja">
<style>
/* ... (既存のCSSは省略) ... */
</style>
<body class="theme-{{theme}}">
<a href="/">← スレッド一覧に戻る</a>
<h1>{{ thread[1] }}</h1>
<p>現在の接続人数: <span id="onlineCount">0</span> 人</p>

<ul id="posts"></ul>

{% if theme == 'i' %}  
<p>※まず自動更新システムを使用してんだけど、まあ多少はね、更新されないこともあって。その際は再読み込みをセンセンシャル！！（迫真）</p>
    {% elif theme == 'm' %}
<p>※自動更新システムを使用していますが、稀に更新されない場合がございます。その際は再読み込みをお願いします</p>
    {% elif theme == 't' %}
<p>※自動更新システムを使用していますが、稀に更新されない場合がございます。その際は再読み込みを願います</p>
    {% elif theme == 'd' %}
<p>※自動更新システムを使用していますが、稀に更新されない場合がございます。その際は再読み込みをお願いします</p>
    {% elif theme == 's' %}
<p>※自動更新システムを使用していますが、稀に更新されない場合がございます。その際は再読み込みをお願いします</p>
    {% elif theme == '2' %}
<p>※自動更新システムを使用していますが、稀に更新されない場合がございます。その際は再読み込みをお願いします</p>
    {% endif %}

<form id="postForm">
  名前: <input type="text" name="name"><br>
  本文: <textarea name="message"></textarea><br>
  <button type="submit">投稿</button>
</form>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const threadId = {{ thread_id }};
const postsList = document.getElementById("posts");
const socket = io();

// 投稿をDOMに追加する関数
function addPostToDOM(post) {
    const li = document.createElement("li");
    li.innerHTML = `<b>${post.name}</b>: ${post.message} <span>(${post.created_at})</span>`;
    postsList.appendChild(li);
}

// 投稿フォームの送信イベント
document.getElementById("postForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);

    let res = await fetch(`/thread/${threadId}/add_post`, {
        method: "POST",
        body: formData
    });

    if (res.ok) {
        // Socket.IO経由で投稿が追加されるので、ここでは何もしない
        form.reset();
    } else {
        alert("投稿に失敗しました");
    }
});

// 初回投稿一覧を取得する関数
async function fetchPosts() {
    let res = await fetch(`/thread/${threadId}/posts_json`);
    if (res.ok) {
        let posts = await res.json();
        postsList.innerHTML = ""; // 既存の投稿をクリア
        posts.forEach(p => addPostToDOM(p));
    }
}

// ページ読み込み時に投稿一覧を取得
fetchPosts();

// Socket.IOリスナー
socket.emit("join_thread", { thread_id: threadId });

socket.on("online_count", function(count) {
    document.getElementById("onlineCount").textContent = count;
});

// 新しい投稿を受信したときの処理
socket.on("new_post", function(post) {
    addPostToDOM(post);
});

window.addEventListener("beforeunload", () => {
    socket.emit("leave_thread", { thread_id: threadId });
});
</script>
</body>
</html>
