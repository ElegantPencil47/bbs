<a href="/">← スレッド一覧に戻る</a>
<h1>{{ thread[1] }}</h1>
<p>現在の接続人数: <span id="onlineCount">0</span> 人</p>

<ul id="posts"></ul>

<form method="post">
  名前: <input type="text" name="name"><br>
  本文: <textarea name="message"></textarea><br>
  <button type="submit">投稿</button>
</form>

<script>
const threadId = {{ thread_id }};
let lastPostId = 0;

function fetchPosts() {
  fetch(`/thread/${threadId}/posts_json?after=${lastPostId}`)
    .then(response => response.json())
    .then(data => {
      const postsUl = document.getElementById("posts");
      data.posts.forEach(post => {
        // 既に表示済みかどうかチェック
        if (!document.getElementById(`post-${post.id}`)) {
          const li = document.createElement("li");
          li.id = `post-${post.id}`;
          li.textContent = `${post.name}: ${post.message}`;
          postsUl.appendChild(li);
        }
      });
      // 最後の投稿IDを更新
      if (data.posts.length > 0) {
        lastPostId = data.posts[data.posts.length - 1].id;
      }
    })
    .catch(err => console.error(err));
}

// 初回取得
fetchPosts();
// 5秒ごとに取得
setInterval(fetchPosts, 5000);
</script>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const socket = io();
socket.emit("join_thread", { thread_id: threadId });

socket.on("online_count", function(count) {
  document.getElementById("onlineCount").textContent = count;
});

window.addEventListener("beforeunload", () => {
  socket.emit("leave_thread", { thread_id: threadId });
});
</script>
