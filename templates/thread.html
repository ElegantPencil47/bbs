<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ thread[1] }}</title>
  <style>
    /* CSSスタイル */
  </style>
</head>
<style>
a {
        text-decoration: none;
color: #000000;        
} 
</style>
<body class="theme-{{theme}}">
<a href="/">← スレッド一覧に戻る</a>
<h1>{{ thread[1] }}</h1>
<p>現在の接続人数: <span id="onlineCount">0</span> 人</p>
<ul id="posts">
  {% for post in posts %}
    <li>#{{ post.num }} <b>{{ post.name | safe }}</b>: {{ post.message | safe }} <span>({{ post.created_at }})</span></li>
  {% endfor %}
</ul>

{% if theme in ['i','m','t','d','s','2'] %}
<p>※自動更新システムを使用していますが、稀に更新されない場合がございます。その際は再読み込みをお願いします</p>
{% endif %}

<form id="postForm">
  名前: <input type="text" name="name"><br>
  本文: <textarea name="message"></textarea><br>
  <button type="submit">投稿</button>
</form>
<a href="https://imgur.com/">画像投稿</a>
<p>imgurに画像をアップロードし画像URLをコピペしてください</p>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
const threadId = {{ thread_id }};
const postsList = document.getElementById("posts");
const socket = io({
  transports:["websocket"]
});

// ユーザーが投稿したメッセージを安全にレンダリングする関数
function safeNl2br(text) {
    // 1. まずHTMLタグをエスケープ
    const escapedText = document.createElement('div');
    escapedText.textContent = text;

    // 2. 次に改行文字を<br>タグに変換して安全なHTMLとして返す
    return escapedText.innerHTML.replace(/\r?\n/g, '<br>');
}

// ImgurのURLを<img>タグに変換する関数
function convertImgurUrls(text) {
    // Imgur画像のURL（i.imgur.comで終わるもの）を検出
    const imgurRegex = /(https?:\/\/(?:i\.)?imgur\.com\/\w+\.(?:jpg|jpeg|png|gif|bmp))/gi;
    return text.replace(imgurRegex, (url) => {
        // 見つかったURLを<img>タグに変換
        return `<img src="${url}" alt="Imgur Image" style="max-width: 100%;">`;
    });
}

// 投稿をDOMに追加
function addPostToDOM(post) {
    const li = document.createElement("li");
    const escapedAndNl2brMessage = safeNl2br(post.message);
    const finalMessage = convertImgurUrls(escapedAndNl2brMessage);
    
    li.innerHTML = `#${post.num} <b>${post.name}</b>: ${finalMessage} <span>(${post.created_at})</span>`;
    
    postsList.appendChild(li);
}

// 初期ロードで投稿一覧を取得
async function fetchPosts() {
    let res = await fetch(`/thread/${threadId}/posts_json`);
    if (res.ok) {
        let posts = await res.json();
        postsList.innerHTML = "";
        posts.forEach(p => addPostToDOM(p));
    }
}

// 投稿フォーム送信
document.getElementById("postForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);

    let res = await fetch(`/thread/${threadId}/add_post`, {
        method: "POST",
        body: formData
    });

    if (res.ok) {
        e.target.reset(); // 自分の投稿はSocket.IOで反映
    } else {
        alert("投稿に失敗しました");
    }
});

// Socket.IO
socket.on("connect", () => {
    console.log("connected:", socket.id);
    socket.emit("join_thread",{thread_id:threadId});
});

socket.on("new_post", (post) => addPostToDOM(post));
socket.on("online_count", (count) => {
    document.getElementById("onlineCount").textContent = count;
});

// ページ離脱時
window.addEventListener("beforeunload", () => {
    socket.emit("leave_thread", { thread_id: threadId });
});

// 初期ロード
fetchPosts();

</script>

</body>
</html>
